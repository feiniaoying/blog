<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>南国枫</title>
  
  <subtitle>简单点，那就如一首诗</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2018-08-16T08:13:30.110Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>chenwt</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2018/08/16/hello-world/"/>
    <id>http://yoursite.com/2018/08/16/hello-world/</id>
    <published>2018-08-16T08:13:30.110Z</published>
    <updated>2018-08-16T08:13:30.110Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>修改测试2</p><p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="technology" scheme="http://yoursite.com/categories/technology/"/>
    
      <category term="computer" scheme="http://yoursite.com/categories/technology/computer/"/>
    
      <category term="computer-aided-art" scheme="http://yoursite.com/categories/technology/computer/computer-aided-art/"/>
    
    
      <category term="tag1" scheme="http://yoursite.com/tags/tag1/"/>
    
      <category term="tag2" scheme="http://yoursite.com/tags/tag2/"/>
    
  </entry>
  
  <entry>
    <title>mysql主从复制架构</title>
    <link href="http://yoursite.com/2018/07/07/mysql/mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%9E%B6%E6%9E%84/"/>
    <id>http://yoursite.com/2018/07/07/mysql/mysql主从复制架构/</id>
    <published>2018-07-07T00:55:29.000Z</published>
    <updated>2018-08-16T08:13:30.110Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="1-主从复制架构"><a href="#1-主从复制架构" class="headerlink" title="1. 主从复制架构"></a>1. 主从复制架构</h1><h2 id="1-1-为什么要做主从复制"><a href="#1-1-为什么要做主从复制" class="headerlink" title="1.1 为什么要做主从复制"></a>1.1 为什么要做主从复制</h2><ul><li>在业务复杂的系统中，有这么一个情景，有一句sql语句需要锁表，导致暂时不能使用读的服务，那么就很影响运行中的业务，使用主从复制，让主库负责写，从库负责读，这样，即使主库出现了锁表的情景，通过读从库也可以保证业务的正常运作。</li><li>做数据的热备</li><li>架构的扩展。业务量越来越大，I/O访问频率过高，单机无法满足，此时做多库的存储，降低磁盘I/O访问的频率，提高单个机器的I/O性能。</li></ul><h2 id="1-2-mysql主从复制的原理"><a href="#1-2-mysql主从复制的原理" class="headerlink" title="1.2 mysql主从复制的原理"></a>1.2 mysql主从复制的原理</h2><p>binlog: binary log，主库中保存更新事件日志的二进制文件。</p><h2 id="1-3-主从复制架构的演变"><a href="#1-3-主从复制架构的演变" class="headerlink" title="1.3 主从复制架构的演变"></a>1.3 主从复制架构的演变</h2><ul><li>一主一从</li></ul><p><img src="http://p7pxipt5l.bkt.clouddn.com/picture/180809/agfdaDJ1cH.png?imageslim" alt="mark"></p><ul><li>一主多从</li></ul><p><img src="http://p7pxipt5l.bkt.clouddn.com/picture/180809/fICGBfGKAI.png?imageslim" alt="mark"></p><ul><li>多级主从</li></ul><p><img src="http://p7pxipt5l.bkt.clouddn.com/picture/180809/GLljjiDhhd.png?imageslim" alt="mark"></p><ul><li>双主</li></ul><p><img src="http://p7pxipt5l.bkt.clouddn.com/picture/180809/12G15E8Al7.png?imageslim" alt="mark"></p><ul><li>多主一从（5.7之后开始支持）</li></ul><p><img src="http://p7pxipt5l.bkt.clouddn.com/picture/180809/BjG1BC8DA0.png?imageslim" alt="mark"></p><ul><li>循环复制<blockquote><p>对于循环数据库镜像，就是多个数据库A、B、C、D等，对其中任一个数据库的修改，都要同时镜像到其它的数据库里。  replicate-same-server-id = 0 </p></blockquote></li></ul><p><img src="http://p7pxipt5l.bkt.clouddn.com/picture/180809/c9mD0HcFb0.png?imageslim" alt="mark"></p><h1 id="2-MySQL主从复制搭建"><a href="#2-MySQL主从复制搭建" class="headerlink" title="2. MySQL主从复制搭建"></a>2. MySQL主从复制搭建</h1><p>在多个从库之间扩展负载以提高性能。在这种环境中，所有写入和更新在主库上进行。但是，读取可能发生在一个或多个从库上。该模型可以提高写入的性能（由于主库专用于更新），同时在多个从库上读取，可以大大提高读取速度。</p><p>参考：</p><ul><li><a href="https://dev.mysql.com/doc/refman/5.7/en/replication.html" target="_blank" rel="noopener">mysql官网主从复制</a></li><li><a href="https://www.cnblogs.com/clsn/p/8150036.html" target="_blank" rel="noopener">MySQL Replication 主从复制全方位解决方案</a></li></ul><h2 id="2-1-准备工作"><a href="#2-1-准备工作" class="headerlink" title="2.1 准备工作"></a>2.1 准备工作</h2><table><thead><tr><th>172.20.28.36</th><th>MySQL-master</th><th>yum install mysql mysql-server -y</th></tr></thead><tbody><tr><td>172.20.28.37</td><td>MySQL-slave1</td><td>yum install mysql mysql-server -y</td></tr><tr><td>172.20.28.38</td><td>MySQL-slave2</td><td>yum install mysql mysql-server -y</td></tr><tr><td>小结：mysql服务是yum安装的，配置文件：/etc/my.cnf  数据存放目录：/var/lib/mysql</td><td></td></tr></tbody></table><h2 id="2-2-安装-MySQL"><a href="#2-2-安装-MySQL" class="headerlink" title="2.2 安装 MySQL"></a>2.2 安装 MySQL</h2><p>bin安装方式：<a href="https://dev.mysql.com/doc/refman/5.7/en/binary-installation.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/binary-installation.html</a></p><p>yum安装方式：<a href="https://dev.mysql.com/doc/refman/5.7/en/linux-installation-yum-repo.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/linux-installation-yum-repo.html</a></p><p>首先在两台机器上装上，保证正常启动，可以使用</p><h2 id="2-3-修改主库和从库的配置文件"><a href="#2-3-修改主库和从库的配置文件" class="headerlink" title="2.3 修改主库和从库的配置文件"></a>2.3 修改主库和从库的配置文件</h2><p>修改 my.cnf</p><blockquote><p>配置 Master 以使用基于二进制日志文件位置的复制，必须启用二进制日志记录并建立唯一的服务器ID,否则则无法进行主从复制。</p></blockquote><p><img src="http://p7pxipt5l.bkt.clouddn.com/picture/180809/b9B28BJK0f.png?imageslim" alt="mark"></p><blockquote><p> 小结：</p><ul><li>库开启binlog日志</li><li>主从server-id不同</li><li>从库服务器能连通主库</li></ul></blockquote><p>master中my.cnf：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@i-t27hedd8 ~]# cat /etc/my.cnf</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">user=mysql</span><br><span class="line"># Disabling symbolic-links is recommended to prevent assorted security risks</span><br><span class="line">symbolic-links=0</span><br><span class="line">server-id=1</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/var/log/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br></pre></td></tr></table></figure><h2 id="2-4-在master端操作"><a href="#2-4-在master端操作" class="headerlink" title="2.4 在master端操作"></a>2.4 在master端操作</h2><p>启动MySQL服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ service mysql.server start</span><br><span class="line">或</span><br><span class="line">systemctl start mysqld.service</span><br></pre></td></tr></table></figure></p><p>登录MySQL<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure></p><p>查看master端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &quot;log_bin&quot;;</span><br><span class="line"></span><br><span class="line">+---------------+-------+</span><br><span class="line"></span><br><span class="line">| Variable_name | Value |</span><br><span class="line"></span><br><span class="line">+---------------+-------+</span><br><span class="line"></span><br><span class="line">| log_bin       | ON    |</span><br><span class="line"></span><br><span class="line">+---------------+-------+</span><br><span class="line"></span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"># 查看 Master-Server ， binlog File 文件名称和 Position值位置 并且记下来</span><br><span class="line">mysql&gt; show master status;</span><br><span class="line"></span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line"></span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line"></span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line"></span><br><span class="line">| mysql-bin.000001 |      341 |              |                  |</span><br><span class="line"></span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line"></span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><strong>配置主库通信：</strong> 查看 Master-Server ， binlog File 文件名称和 Position值位置 并且记下来</p><p>查看主服务器的运行状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000001 |      341 |              |                  |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>在主库创建复制用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant replication slave on *.* to &apos;oldboy123&apos;@&apos;172.20.28.%&apos; identified by &apos;oldboy123&apos;;</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>列出当前连接自己的从库列表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW SLAVE HOSTS;</span><br><span class="line">+-----------+--------+------+-------------------+-----------+</span><br><span class="line">| Server_id | Host   | Port | Rpl_recovery_rank | Master_id |</span><br><span class="line">+-----------+--------+------+-------------------+-----------+</span><br><span class="line">|        10 | slave1 | 3306 |                 0 |         1 |</span><br><span class="line">+-----------+--------+------+-------------------+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>获取binlog文件列表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      1190 |</span><br><span class="line">+------------------+-----------+</span><br></pre></td></tr></table></figure></p><h2 id="2-5-分别在两台从库上操作"><a href="#2-5-分别在两台从库上操作" class="headerlink" title="2.5 分别在两台从库上操作"></a>2.5 分别在两台从库上操作</h2><h3 id="2-5-1-设置从库与主库通信信息"><a href="#2-5-1-设置从库与主库通信信息" class="headerlink" title="2.5.1 设置从库与主库通信信息"></a>2.5.1 设置从库与主库通信信息</h3><p>要设置从库与主库进行通信，进行复制，使用必要的连接信息配置从库在从库上执行以下语句</p><p>参数格式，请勿执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CHANGE MASTER TO</span><br><span class="line">    -&gt;     MASTER_HOST=&apos;master_host_name&apos;,</span><br><span class="line">    -&gt;     MASTER_USER=&apos;replication_user_name&apos;,</span><br><span class="line">    -&gt;     MASTER_PASSWORD=&apos;replication_password&apos;,</span><br><span class="line">    -&gt;     MASTER_LOG_FILE=&apos;recorded_log_file_name&apos;,</span><br><span class="line">    -&gt;     MASTER_LOG_POS=recorded_log_position;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 分别在两台从库上操作</span><br><span class="line">mysql&gt; CHANGE MASTER TO</span><br><span class="line">    -&gt; MASTER_HOST=&apos;172.20.28.36&apos;,</span><br><span class="line">    -&gt; MASTER_USER=&apos;oldboy123&apos;,</span><br><span class="line">    -&gt; MASTER_PASSWORD=&apos;oldboy123&apos;,</span><br><span class="line">    -&gt; MASTER_LOG_FILE=&apos;mysql-bin.000001&apos;,</span><br><span class="line">    -&gt; MASTER_LOG_POS=341;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges；</span><br></pre></td></tr></table></figure><h3 id="2-5-2-启动从服务器复制线程"><a href="#2-5-2-启动从服务器复制线程" class="headerlink" title="2.5.2 启动从服务器复制线程"></a>2.5.2 启动从服务器复制线程</h3><p>启动从库复制线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>停止从库复制线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; STOP SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><h3 id="2-5-3-查看复制状态"><a href="#2-5-3-查看复制状态" class="headerlink" title="2.5.3 查看复制状态"></a>2.5.3 查看复制状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.20.28.36</span><br><span class="line">                  Master_User: oldboy123</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 341</span><br><span class="line">               Relay_Log_File: master2-relay-bin.000003</span><br><span class="line">                Relay_Log_Pos: 320</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>检查主从复制通信状态</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 必须都是 Yes</span><br><span class="line">Slave_IO_State #从站的当前状态 </span><br><span class="line">Slave_IO_Running： Yes #读取主程序二进制日志的I/O线程是否正在运行 </span><br><span class="line">Slave_SQL_Running： Yes #执行读取主服务器中二进制日志事件的SQL线程是否正在运行。与I/O线程一样 </span><br><span class="line">Seconds_Behind_Master #是否为0，0就是已经同步了</span><br></pre></td></tr></table></figure><p>必须都是 Yes；如果不是原因主要有以下 4 个方面：</p><ul><li>1、网络不通 </li><li>2、密码不对 </li><li>3、MASTER_LOG_POS 不对 ps </li><li>4、mysql 的 auto.cnf server-uuid 一样（可能你是复制的mysql）<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ find / -name &apos;auto.cnf&apos;</span><br><span class="line">$ cat /var/lib/mysql/auto.cnf</span><br><span class="line">[auto]</span><br><span class="line">server-uuid=6b831bf3-8ae7-11e7-a178-000c29cb5cbc # 按照这个16进制格式，修改server-uuid，重启mysql即可</span><br></pre></td></tr></table></figure></li></ul><h2 id="2-6-一些命令"><a href="#2-6-一些命令" class="headerlink" title="2.6 一些命令"></a>2.6 一些命令</h2><p>查看主服务器的运行状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000001 |     1190 |              |                  |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br></pre></td></tr></table></figure></p><p>查看从服务器主机列表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave hosts;</span><br><span class="line">+-----------+------+------+-----------+--------------------------------------+</span><br><span class="line">| Server_id | Host | Port | Master_id | Slave_UUID                           |</span><br><span class="line">+-----------+------+------+-----------+--------------------------------------+</span><br><span class="line">|         2 |      | 3306 |         1 | 6b831bf2-8ae7-11e7-a178-000c29cb5cbc |</span><br><span class="line">+-----------+------+------+-----------+--------------------------------------+</span><br></pre></td></tr></table></figure></p><p>获取binlog文件列表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      1190 |</span><br><span class="line">+------------------+-----------+</span><br></pre></td></tr></table></figure></p><p>只查看第一个binlog文件的内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; mysql&gt; show binlog events;</span><br><span class="line">+------------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Log_name         | Pos | Event_type     | Server_id | End_log_pos | Info                                                                                                                                                                                                  |</span><br><span class="line">+------------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |   4 | Format_desc    |         1 |         123 | Server ver: 5.7.19-log, Binlog ver: 4                                                                                                                                                                 |</span><br><span class="line">| mysql-bin.000001 | 123 | Previous_gtids |         1 |         154 |                                                                                                                                                                                                       |</span><br><span class="line">| mysql-bin.000001 | 420 | Anonymous_Gtid |         1 |         485 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;                                                                                                                                                                  |</span><br><span class="line">| mysql-bin.000001 | 485 | Query          |         1 |         629 | GRANT REPLICATION SLAVE ON *.* TO &apos;replication&apos;@&apos;192.168.252.124&apos;                                                                                                                                     |</span><br><span class="line">| mysql-bin.000001 | 629 | Anonymous_Gtid |         1 |         694 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;                                                                                                                                                                  |</span><br><span class="line">| mysql-bin.000001 | 694 | Query          |         1 |         847 | CREATE DATABASE `replication_wwww.ymq.io`                                                                                                                                                             |</span><br><span class="line">| mysql-bin.000001 | 847 | Anonymous_Gtid |         1 |         912 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;                                                                                                                                                                  |</span><br><span class="line">| mysql-bin.000001 | 912 | Query          |         1 |        1190 | use `replication_wwww.ymq.io`; CREATE TABLE `sync_test` (`id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(255) NOT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8 |</span><br><span class="line">+------------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure></p><p>查看指定binlog文件的内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; mysql&gt; show binlog events in &apos;mysql-bin.000001&apos;;</span><br><span class="line">+------------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Log_name         | Pos | Event_type     | Server_id | End_log_pos | Info                                                                                                                                                                                                  |</span><br><span class="line">+------------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |   4 | Format_desc    |         1 |         123 | Server ver: 5.7.19-log, Binlog ver: 4                                                                                                                                                                 |</span><br><span class="line">| mysql-bin.000001 | 123 | Previous_gtids |         1 |         154 |                                                                                                                                                                                                       |</span><br><span class="line">| mysql-bin.000001 | 420 | Anonymous_Gtid |         1 |         485 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;                                                                                                                                                                  |</span><br><span class="line">| mysql-bin.000001 | 485 | Query          |         1 |         629 | GRANT REPLICATION SLAVE ON *.* TO &apos;replication&apos;@&apos;192.168.252.124&apos;                                                                                                                                     |</span><br><span class="line">| mysql-bin.000001 | 629 | Anonymous_Gtid |         1 |         694 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;                                                                                                                                                                  |</span><br><span class="line">| mysql-bin.000001 | 694 | Query          |         1 |         847 | CREATE DATABASE `replication_wwww.ymq.io`                                                                                                                                                             |</span><br><span class="line">| mysql-bin.000001 | 847 | Anonymous_Gtid |         1 |         912 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;                                                                                                                                                                  |</span><br><span class="line">| mysql-bin.000001 | 912 | Query          |         1 |        1190 | use `replication_wwww.ymq.io`; CREATE TABLE `sync_test` (`id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(255) NOT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8 |</span><br><span class="line">+------------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure></p><p>启动从库复制线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>停止从库复制线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; STOP SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><h1 id="3-复制实现细节分析"><a href="#3-复制实现细节分析" class="headerlink" title="3. 复制实现细节分析"></a>3. 复制实现细节分析</h1><p>MySQL主从复制功能使用三个线程实现，一个在主服务器上，两个在从服务器上</p><p>每个主/从连接有三个线程。主服务器为每个当前连接的从服务器创建一个二进制日志转储线程，每个从服务器都有自己的I/O和SQL线程。</p><p>从服务器使用两个线程将读取更新与主服务器更新事件，并将其执行为独立任务。因此，如果语句执行缓慢，则读取语句的任务不会减慢。</p><h2 id="3-1-Binlog转储线程"><a href="#3-1-Binlog转储线程" class="headerlink" title="3.1 Binlog转储线程"></a>3.1 Binlog转储线程</h2><p>当从服务器与主服务器连接时，主服务器会创建一个线程将二进制日志内容发送到从服务器。 该线程可以使用 语句 SHOW PROCESSLIST(下面有示例介绍) 在服务器 sql 控制台输出中标识为Binlog Dump线程。</p><p>二进制日志转储线程获取服务器上二进制日志上的锁，用于读取要发送到从服务器的每个事件。一旦事件被读取，即使在将事件发送到从服务器之前，锁会被释放。</p><h2 id="3-2-从服务器I-O线程"><a href="#3-2-从服务器I-O线程" class="headerlink" title="3.2 从服务器I/O线程"></a>3.2 从服务器I/O线程</h2><p>当在从服务器sql 控制台发出 START SLAVE语句时，从服务器将创建一个I/O线程，该线程连接到主服务器，并要求它发送记录在主服务器上的二进制更新日志。</p><p>从机I/O线程读取主服务器Binlog Dump线程发送的更新 （参考上面 Binlog转储线程 介绍），并将它们复制到自己的本地文件二进制日志中。</p><p>该线程的状态显示详情 Slave_IO_running 在输出端 使用 命令SHOW SLAVE STATUS<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 使用\G语句终结符,而不是分号,是为了，易读的垂直布局</span><br><span class="line">mysql&gt; SHOW SLAVE STATUS\G</span><br></pre></td></tr></table></figure></p><h2 id="3-3-从服务器SQL线程"><a href="#3-3-从服务器SQL线程" class="headerlink" title="3.3 从服务器SQL线程"></a>3.3 从服务器SQL线程</h2><p>从服务器创建一条SQL线程来读取由主服务器I/O线程写入的二级制日志，并执行其中包含的事件。</p><h2 id="3-4-查看复制细节"><a href="#3-4-查看复制细节" class="headerlink" title="3.4 查看复制细节"></a>3.4 查看复制细节</h2><p>在 Master 主服务器，查看Binlog转储线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  SHOW FULL PROCESSLIST\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">     Id: 22</span><br><span class="line">   User: repl</span><br><span class="line">   Host: node2:39114</span><br><span class="line">     db: NULL</span><br><span class="line">Command: Binlog Dump</span><br><span class="line">   Time: 4435</span><br><span class="line">  State: Master has sent all binlog to slave; waiting for more updates</span><br><span class="line">   Info: NULL</span><br></pre></td></tr></table></figure></p><blockquote><ul><li>Id: 22是Binlog Dump服务连接的从站的复制线程 </li><li>Host: node2:39114 是从服务，主机名 级及端口 </li><li>State: 信息表示所有更新都已同步发送到从服务器，并且主服务器正在等待更多更新发生。 </li></ul></blockquote><p>在 Slave 从服务器 ，查看两个线程的更新状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW PROCESSLIST\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">     Id: 6</span><br><span class="line">   User: system user</span><br><span class="line">   Host: </span><br><span class="line">     db: NULL</span><br><span class="line">Command: Connect</span><br><span class="line">   Time: 6810</span><br><span class="line">  State: Waiting for master to send event</span><br><span class="line">   Info: NULL</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">     Id: 7</span><br><span class="line">   User: system user</span><br><span class="line">   Host: </span><br><span class="line">     db: NULL</span><br><span class="line">Command: Connect</span><br><span class="line">   Time: 3069</span><br><span class="line">  State: Slave has read all relay log; waiting for more updates</span><br><span class="line">   Info: NULL</span><br></pre></td></tr></table></figure></p><blockquote><ul><li>Id: 6是与主服务器通信的I/O线程 </li><li>Id: 7是正在处理存储在中继日志中的更新的SQL线程</li></ul></blockquote><p>如果在主服务器上在设置的超时，时间内 Binlog Dump线程没有活动，则主服务器会和从服务器断开连接。超时取决于的服务器系统变量 值 net_write_timeout(在中止写入之前等待块写入连接的秒数，默认10秒)和 net_retry_count;(如果通信端口上的读取或写入中断，请在重试次数，默认10次) 设置 <a href="https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html" target="_blank" rel="noopener">服务器系统变量</a></p><h1 id="4-更多常见主从复制问题"><a href="#4-更多常见主从复制问题" class="headerlink" title="4 更多常见主从复制问题"></a>4 更多常见主从复制问题</h1><p><a href="https://dev.mysql.com/doc/refman/5.7/en/faqs-replication.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/faqs-replication.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
      <category term="mysql" scheme="http://yoursite.com/categories/mysql/"/>
    
    
  </entry>
  
</feed>
